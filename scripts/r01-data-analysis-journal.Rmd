---
title: "Vietnam FoF Survey Analysis - Journal"
author: "mz"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
  html_document: default
bibliography: "../misc/vn-lit.bib"
---

```{r "setup", include=FALSE}
## this is to set up the main folder as the root
## although this doesnot work for the YAML designations e.g. bibliography, css files etc..:(
require("knitr")
opts_knit$set(root.dir = "C:/Users/sfos0247/Dropbox/analysis/Vietnam/VietnamSurvey")
```


```{r "load data", include=FALSE}
# has to be in separate chunk from setup!
load("data/working-copy.RData")
```
# Thursday 16.3.2017 

Received clean data from SH, in package:

* `OIPA_FoF Farming Quest_Eng_final_20161220.docx` - final version of the questionnaire in English
* `OIPA_IPPM ToR for Survey in TB & VP Dec2016_final.pdf` Copy of our TOR
* `full_data_v1_no_dup.dta` - the dataset in STATA format

# Monday 20.3.2017

Asked by SH to do a quick first trawl of the dataset by Thursday and report. 

* Initialised a new GitHub repository https://github.com/majazaloznik/VietnamSurvey for the project, for version control, transparency and reproducibility **(All data and any dynamically generated outputs are kept offline)**.

### Setup dir structure:
`*` indicate the folders and all their contents are hidden/non-public material. 

```
VietnamSurvey/
|---data/*
|   |---RawData/*
|   |   |---full_data_v1_no_dup.dta
|   |   |---OIPA_FoF Farming Quest_Eng_final_20161220.docx
|   |   `---OIPA_IPPM ToR for Survey in TB & VP Dec2016_final.pdf
|   |---outputs/*
|   |   `---
|   |---working-copy.RData
|   |---full_data_v1_no_dup.dta
|   `---full_data_v1_no_dup_stata-12-11.dta
|---scripts/
|   |---00-scratchpad.R
|   |---01-data-import.R
|   `---r01-data-analysis-journal.Rmd
|---reports/*
|   `---r01-data-analysis-journal.pdf
|---misc/
|   `---vn-lit.bib
|---.gitignore
`---VietnamSurvey.Rproj
```

### Data Import

This is a Stata 14 .dta file, imported using the `readstata13` package [@2016read]. Upon first inspection of the file:

* was created 26 Dec 2016 21:48, from "EpiData based on full_data.rec"
* 414 cases 
* 441 variables 

### Annonymization of the data

The data has three sets of *name* variables: 

1. `[7] hhhead` - *Name of Household head*
2. `[9] respondent` - *Name of respondent*
3. `[10] phongvan` - *Name of interviewer*

All three will be removed:

* The interviewer name can be easily removed, there is a `interviewer code` variable, so names are not necessary. 
* before the identifiable names of the respondent and HoH are removed, a new variable is created to check if the two are the same. **ISSUE** since it has already been established that there are typos in data input the only way to be sure that this is correct is manually! There were 6 typos found.. 
* **New** `id` - *Unique ID* - why did this not exist?
* **New** `n1` - *Was the respondent also the head of household?* derived from `hhhead` and `respondent`, then checked
* Now I can remove the three variables with names. 

### Working copy of data

Create a working copy of the data instead (`data\working-copy.RData`), so it keeps the
data frame with attributes, especially useful for the full descriptions in `$var.labels`. 

### Commit `01-data-import.R`
This should be a good working copy of the data, as the output of `01-data-import.R`, which is done for now. Next stop: new variables. 

### Start `02-new-variables.R`

Setup: OK, so new variables are added at the end, all need a var.labels attribute, and then should be slotted into the position just after the last variable it was derived from. Both the column, and the var.labels. attribute need to change order as well.

# Tuedsay 21.3.2017

Setup of **first trawl** through the data is as follows:

1. Report file with issues as they come up - this is feedback on the quality of data and whatever issues are uncovered in the first trawl through the data. It is not a final verdict.. Written in `r02-survey-first-trawl.Rmd`, to be compiled to .docx for SH et al and tracking changes, etc. 

2. A table/list of the variables, both original and derived as the trawl progresses. Actually I'll do two, one of the original(anon) file, and one that builds up as I go along. 
  * `r00-survey-variable-list-originals-only.Rmd
  * `r00-survey-variable-list.Rmd

3. A report - first cut type thing:  For each variable (where it makes sense), the univariate distribution or frequency is provided with a chart, as well as the regional split. 

* OK, so turns out the .dta file does not actually have any labels for the variable values!! At all! So I will need to manually add them, and for this reason it's easier if I use `memsic` datasets to manage the data, especially since it has better support for attributes and labels [@2016memi]. 

* This means a non reproducible step: Loading the data on SZ's machine, opening in Stata 14 and saving as a Stata 12 file. Now editing the `01-data-import.R` script to use memisc instead. 

* But cool, get to work with datasets as a type, which I've already been doing for MNM, so easier to get into it. 

* Set up `00-my-functions.R`

* **New function** `FunSwap` to swap order of items in dataset and slotting newly derived vars where they logically belong. 

* Now set up new slots in the   `annotation()` slot of the dataset, to add a flag to each variable if it's derived or original, and where derived from. 

* Fixed `01-data-import.R` to use both FunSwap on the new varz, and to give them annotations. Also give annotations to all old a.k.a. original variables. 

* Now that import is cool and all fields are available, can do `r00-survey-variable-list-originals-only.Rmd

* OK, now the variable table list can be run from import, so it is always the same as the working-copy.RData

`01-data-import.R`  now **finished** - committed. Also creates list of original variables - to `r00-survey-variable-list-originals-only.pdf` in `reports\` 

This is now the annonymised version of the data. should have 439 variables. 

OK, now finally to trawling through.. 

1. remove `province` - 6 typos
2. label `procode` correctly instead
3. remove `distric` - 5 typos
4. label `distcode` correctly instead
5. remove `commune` - 3 typos
6. label `commcode` correctly instead
7. weird missing value in `hhcode`, replace with 99 as new missing var. [!! come back to this?]
8. measurelement level for `cphongvan`
9. double check `cphongvan` and `phongvan` as well as (apparently supervisor) `cnhaptin` and `nhaptin`, loads of typos, non unique mapping.. Need to kludge the `cphongvan` one. - this needs to be done in import, before annonymizing. 
10. two `cphongvan` codes, 1 and 12, map to teh sam `phongvan` name, need to merge (to 1)
11. `a1` - measurement, labels
12. `a2` - YoB checked for within interviewer patterns, eyeballed and looks ok. 

```{r, echo = FALSE}
plot(ds$a2, jitter(ds$cphongvan), ylab = "Interviewer code", xlab = "Year of Birth")
```

13. `a3` - measurement, labels
14. `a5` - measurement, labels

Break: Next step, set up Functions for First cut. 
ToDo update folder and file structure!


<!--
RANDOM COMMENTS, TO DO, KEEP FOR LATER..

-->


<!--
rmarkdown::render("scripts/r01-data-analysis-journal.Rmd", output_format = "pdf_document", output_dir = "reports")
-->